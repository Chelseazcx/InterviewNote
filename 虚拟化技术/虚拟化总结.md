# 虚拟化总结

Libvirt概念

以KVM虚拟化技术为例，包含宿主机，hypervisor，虚拟机。KVM是内核的一个驱动模块，叫KVM.ko，用来模拟CPU和内存。然后上层使用QEMU，模拟用户组价和IO设备，通过IOctl连接KVM，仿真出一套虚拟的操作系统。

Libvirt是一种工具，用来管理虚拟机。包括虚拟机的创建，启动，重启，中断，恢复，关闭和销毁。同时也是云计算框架底层调用API，管理虚拟机的方式，包括OpenStack，opennebula

libvirt使用

Libvirt管理工具主要有virsh命令行，virt-manager图形化管理，guestfish交互式命令工具。通常使用virsh+xml+镜像文件的方式。首先在xml中定义域，包括内存大小，vcpu对应物理cup，热插拔，disk，网卡，外设等。然后通过命令行define，start。

Libvirt技术

Libvirt总共分为三层：python接口层，c接口层，Libvirtd服务层。把用户传入参数转换成Libvirt协议数据结构，发送到libvirt服务端，然后等待消息回复

服务管理API包括hypervisor相互、域、节点、网络、存储卷、存储池、事件机制管理、数据流。

这些资源都会被抽象成类，然后所有对象都继承自virobject，如果对象需要锁的保护，需要继承virobjectLockable。每个对象创建后，都有唯一标识符，然后使用引用计数器管理对像。

对戏那个锁最终实现是自旋锁机制。Libvirt调用都是从线程池获取一个空闲线程处理，这样就存在并发执行。任务锁机制可以实现并发操作，实现方式是数据结构记录任务信息，包括当前执行的任务，执行的线程，触发接口，异步任务，进度状态等。接口管控对象，包括开始，结束，设置，恢复，清理和持久化任务。

事件机制管理

libvirt分为两部分，客户端和服务端。本质上是一个分发器，接收到事件，根据事件找到匹配的动作。步骤包括注册默认事件和回调函数，启动事件处理功能，触发事件RPC上报，Libvirt把事件压入队列，然后事件处理和回调。



虚拟化

CPU虚拟化

CPU的运行状态总共有七种，PL0(USR)，PL1(FIR/IRQ,SYS,ABT,SVC,UND和MON)，PL2(HPY)。在原来七种模式上扩展Monitor和hypervisor。vcpu包括用户模式，内核模式，客户模式。虚拟机多个vcpu可以共享一个物理CPU。所以虚拟机对应一个进程，vcpu对应进程里面的一个线程。Linux调用systemcall或者中断，从用户控件陷入内核控件，对应虚拟机，执行hyper call，发生中断或者执行敏感指令都可以进入VMM，Linux进程信息保存在task struct，vcpu把相关状态和上下文放入VMCS(virtual-machine control data structures).

NUMA架构

每个处理器都可以访问自己的和别的处理器的存储器，访问自己的存储器，访问自己的存储器比访问别的快。速度相差10-100倍。所以NUMA调优目的是让处理器访问自己的存储器。

物理内存对应虚拟内存，虚拟化技术是在OS上有对虚拟内存再虚拟化。所以虚拟内存的转换需要经过两次，才能得到最终的物理地址。

EPT MMU

中断虚拟化

IO虚拟化

Hypervisor提供了两种机制来实现IO设备的访问，一种是透传，一种是模拟。IOMMU查找的页表通常是专门的I/O page tables

# TrustZone

概念

TrustZone提供芯片级别上对硬件资源的保护和隔离。分为两种操作系统同时工作，normal world和secure world。素有的安全资源都放在secure world，包括指纹，人脸识别，数字版权等。普通程序需要遵循TEE API规则，然后实现两侧通信。可能只返回调用结果，甚至错误请求将不会得到任何回应。

上层应用

普通时间使用TrustZone的基本步骤是，初始化context，打开session，传递命令和参数，关闭session，结束context。安全世界接受到参数和命令后，然后调用统一API，对敏感信息做存储或对比。

安全存储

在安全世界存储有两种方式，使用文件系统或使用emmc上的RPMB。结构包括一个数据库文件和以数字命名的文件。数据库文件保存所有保护文件的目录和节点信息。当需要使用某个安全文件时，先读取dirf.db的内容，找到文件名的hash值对应的编号，按照这个编号找到对应文件，然后进行操作。内部使用三种密钥对数据加密。

驱动

安全世界REE侧提供库函数，实现方式每个厂商可能不同，但是对外接口都遵循统一API规范。在Linux有一个常驻进程，帮助TEE通过进程访问REE侧资源，包括读取文件系统，镜像文件，数据库内容。在Linux内核存在OP-TEE驱动，目的是解析参数，重组数据，载入共享内存，触发安全监控模式嗲用(smc)进入monitor，然后发送到TEE侧

内核

安全引导

安全引导过程使用电子签名进行验签，内容包括证书和hash加密。整个过程就是先验证书，再验证镜像文件的合法性。启动过程采用链式验签，第一级验签来自chiprom固化代码，然后经过BL1，BL2，BL3，加载镜像包括OP-TEE os，uboot/edk2，LInux内核镜像。初始化的内容主要验签，加载镜像，初始化中断向量表，CPU相关设定，MMU，软件运行环境。

